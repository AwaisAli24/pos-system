<%- include('header.ejs') %>
    <%- include('sidebar.ejs') %>
        <div class="add">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-md-10 mx-5 mt-5">
                        <div class="form-group">
                            <label for="input-datalist">Enter:</label>
                            <div class="search-box">
                                <input type="text" class="form-control" placeholder="Search item" name="Search"
                                    list="list-timezone" id="input-datalist" autofocus>
                                <datalist id="list-timezone">
                                    <% products.forEach((product)=> { %>
                                        <option value="<%= product.id %>"></option>
                                        <% }); %>
                                </datalist>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- <div class="row r2 justify-content-center"> -->

                <table class="table item-table mt-5 mx-3">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Product Name</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Delete</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="billing-body" class="billing-body">
                    </tbody>
                </table>
                <!-- </div> -->
                 <div class="discount">
                    <input type="text" class="form-control mt-5 mx-5" placeholder="Discount">
                 </div>
                <div class="cardg mx-5 mt-5">
                    <div class="card-body">
                        <div class="">
                            <h4>Grand Total: Rs <span class="grand-total">0</span></h4>

                        </div>
                    </div>
                </div>
                <div class="row justify-content-end">
                    <div class="col-3 mt-3">
                        <button class="btn btn-warning">Print<svg xmlns="http://www.w3.org/2000/svg" width="20"
                                height="25" fill="green" class="bi bi-printer mx-2" viewBox="0 0 16 16">
                                <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1" />
                                <path
                                    d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1" />
                            </svg></button>
                        <button type="button" class="btn btn-primary editbtn checkout" data-bs-toggle="modal"
                            data-bs-target="#checkmodal">
                            Checkout
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="25" fill="white"
                                class="bi bi-bag-check" viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                    d="M10.854 8.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708 0" />
                                <path
                                    d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1m3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="modal fade" id="checkmodal" tabindex="-1" aria-labelledby="exampleModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Checkout</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <form action="/billing/add" method="post">
                                <div class="modal-body">

                                </div>
                                <div class="modal-footer">
                                    <h5>Grand Total: Rs<span class="grand-total1">0</span></h5>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="method"
                                            id="flexRadioDefault1" value="online">
                                        <label class="form-check-label" for="flexRadioDefault1">
                                            Online
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="method"
                                            id="flexRadioDefault2" checked value="cash">
                                        <label class="form-check-label" for="flexRadioDefault2">
                                            Cash
                                        </label>
                                    </div>
                                    <div class="mb-3 payment">
                                        <input type="text" class="form-control mt-2 " id="exampleFormControlInput1"
                                            placeholder=" Enter Name" name="name">
                                        <input type="text" class="form-control mt-2" id="exampleFormControlInput1"
                                            placeholder=" Enter Phone" name="phone">
                                    </div>
                                    <input type="hidden" name="total" class="total-price" value="0">
                                    <button type="submit" class="btn btn-secondary" data-bs-dismiss="modal">
                                        Confirm <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                            fill="yellowgreen" class="bi bi-check-lg" viewBox="0 0 16 16">
                                            <path
                                                d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z" />
                                        </svg>
                                    </button>
                                </div>
                        </div>
                    </div>
                </div>
                </form>
            </div>
        </div>
        <script>
            const allProducts = <%- JSON.stringify(products) %>;
            const search = document.getElementById("input-datalist");
            const tableBody = document.getElementById("billing-body");
            const addedProducts = {};
            const total = document.querySelector(".grand-total");
            const totalPrice = document.querySelector(".total-price")
            const itemTable = document.querySelector(".item-table");
            const modalBody = document.querySelector(".modal-body");
            const checkout = document.querySelector(".checkout");
            const grandTotal1 = document.querySelector(".grand-total1");

            search.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    const input = search.value.trim();
                    if (!input) return;

                    const product = allProducts.find(p => p.id === input);

                    if (!product) {
                        alert("Product not found!");
                        search.value = "";
                        return;
                    }

                    if (addedProducts[product.id]) {
                        // Get the existing row
                        const existingRow = tableBody.querySelector(`tr[data-id='${product.id}']`);
                        const qtyInput = existingRow.querySelector(".qty-input");
                        let currentQty = parseInt(qtyInput.value);

                        if (currentQty < product.quantity) {
                            qtyInput.value = currentQty + 1;
                            const newTotal = (currentQty + 1) * product.price;
                            existingRow.querySelector(".total").textContent = newTotal;
                            updatePrice();
                        } else {
                            alert("Maximum quantity reached for this product.");
                        }

                        search.value = "";
                        return;
                    }

                    console.log(product);

                    if (product.quantity <= 0) {
                        alert("Product is not available");
                        search.value = "";
                        return;
                    }
                    addedProducts[product.id] = true;

                    const row = document.createElement("tr");
                    row.setAttribute("data-id", product.id); // Add this line

                    row.innerHTML = `
    <td>${tableBody.children.length + 1}</td>
    <td>
        ${product.name}
        <input type="hidden" name="item[]" value="${product.id}">
    </td>
    <td>${product.price}</td>
    <td>
        <input type="number" name="quantity[]" value="1" min="1" class="qty-input">
    </td>
    <td><button class="btn btn-danger btn-sm delete-btn">Delete</button></td>
    <td class="total">${product.price}</td>
`;

                    // Handle delete
                    row.querySelector(".delete-btn").addEventListener("click", () => {
                        delete addedProducts[product.id];
                        row.remove();
                        updatePrice();
                        updateRowNumbers();
                    });

                    // Handle quantity change
                    row.querySelector(".qty-input").addEventListener("input", (e) => {
                        const qty = parseInt(e.target.value) || 0;
                        if (qty > product.quantity) {
                            alert("Product is not available reduce the quantity");
                            e.target.value = product.quantity;
                            return;
                        }
                        row.querySelector(".total").textContent = qty * product.price;
                        updatePrice()
                    });

                    tableBody.appendChild(row);
                    search.value = "";
                }
                updatePrice();
            });

            function updateRowNumbers() {
                const rows = tableBody.querySelectorAll("tr");
                rows.forEach((row, index) => {
                    row.children[0].textContent = index + 1;
                });
            }
            function updatePrice() {
                const priceRows = document.querySelectorAll(".total");
                let grandTotal = 0;
                priceRows.forEach((price) => {
                    grandTotal += (parseInt(price.innerText));
                })
                total.innerText = grandTotal;
                totalPrice.value = grandTotal;
                return grandTotal;
            }
            checkout.addEventListener("click", () => {
                modalBody.appendChild(itemTable);
                grandTotal1.innerText = updatePrice();
                itemTable.removeChild();
            })
            let online = document.querySelector("#flexRadioDefault1");
            let payment = document.querySelector(".payment");
            let cash = document.querySelector("#flexRadioDefault2");
            online.addEventListener("click", () => {
                payment.style.display = "block";
            })
            cash.addEventListener("click", () => {
                payment.style.display = "none";
            })
        </script>

        <%- include('footer.ejs') %>